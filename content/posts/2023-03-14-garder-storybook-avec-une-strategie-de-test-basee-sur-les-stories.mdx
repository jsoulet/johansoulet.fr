---
date: '2023-03-14'
title: "Grader Storybook √† jour en cr√©ant une strat√©gie de tests bas√©e sur vos Stories"
featuredImage: '../images/2023-02-storybook/microscope.jpg'
lang: fr
i18n:
  - locale: en
    slug: /2023-03-14-keep-storybook-up-to-date-over-time-with-story-based-testing
chapo: "Comme toute application m√©tier, Storybook doit √™tre test√© pour √©viter les regressions. Le format CSF 2.0 permet de s‚Äôinterfacer avec Jest et Testing Library pour que les Stories deviennent le point d‚Äôentr√©e de la strat√©gie de tests, et que les √©volutions de composants se fassent en toute s√©r√©nit√©."

---

# Pourquoi faut-il tester vos stories ?

Au premier abord, il peut sembler contre-intuitif de tester les stories. Si votre processus de d√©veloppement implique de commencer par Storybook et de cr√©er des composants isol√©s qui sont ensuite ajout√©s √† l'application web, il peut sembler qu'il n'y ait pas besoin de tester les histoires, puiqu‚Äôelles seront toujours fonctionnelles. Cependant, ce n'est pas toujours le cas.

Au fur et √† mesure que votre √©quipe se d√©veloppe, vous aller embaucher de nouveaux co√©quipiers qui ne sont pas habitu√©s √† d√©velopper avec Storybook. Lorsqu'ils ont besoin de mettre √† jour un composant existant, ils vont v√©rifier que l'int√©gration avec le code de l‚Äôapplication m√©tier r√©pond aux nouvelles sp√©cifications et mettre √† jour les tests, que vous aurez automatis√©s dans la CI. Cependant, s'ils effectuent un changement majeur, comme la modification d'un nom ou du type d‚Äôune props, ils ne vont pas n√©cessairement se rendre compte que les stories existantes ne fonctionnent plus. Et si le composant est utilis√© comme bloc pour la composition d'autres composants de plus haut niveau, ces stories peuvent √©galement √™tre buggu√©es. Petit √† petit, c‚Äôest donc toute votre syst√®me de documentation qui sera inutilisable.

M√™me si vous vous efforcez de sensibiliser vos co√©quipiers aux avantages de l'utilisation de Storybook et √† l'importance de le maintenir √† jour, il est toujours possible que les √™tres humains commettent des erreurs (selon la loi de Murphy). Le seul moyen d'emp√™cher cela est de tester automatiquement le code Storybook, tout comme vous testeriez votre code m√©tier. Cela contribuera √† garantir que vos composants et leur documentation sont toujours √† jour. En r√©sum√©, la solution √† ce probl√®me consiste √† tester les stories.

<Image isSmall>

![](../images/2023-02-storybook/test-schema.png)

</Image>

1. Le composant est rendu dans Storybook √† des fins de documentation
2. Le test v√©rifie que la story est rendue comme pr√©vu
3. En fin de compte, le composant est test√© ü•≥

Il y a quelques ann√©es, nous n'avions pas les outils n√©cessaire pour int√©grer ce workflow dans votre process de d√©veloppement. Cependant, depuis la sortie de CSF 2.0, des outils externes ont int√©gr√© le format et il est d√©sormais possible d'adopter cette philosophie sans trop de difficult√©s.

# Les principaux avantages de baser les tests sur les histoires

## Ne pas dupliquer les sc√©narios

Il est recommand√© de cr√©er une story pour chaque cas d'utilisation d'un composant, afin de documenter toutes ses variants. Il est √©galement recommand√© de cr√©er un test par cas d'utilisation pour s'assurer que le composant continue de fonctionner correctement au fil du temps.

En basant les tests sur les story, vous √©viderez ainsi de dupliquer le sc√©nario et pourrez l‚Äôutiliser √† la fois √† des fins de documentation et de test.

## Cr√©er un aper√ßu visuel des tests Jest

Les tests Jest reposent sur un rendu headless et peuvent √™tre difficiles √† interpr√©ter lorsqu'ils buguent. Lorsque vous rencontrez des probl√®mes inattendus, vous devez souvent logguer le HTML dans la console pour essayer de comprendre ce qui se passe. Cela peut √™tre particuli√®rement fastidieux lorsqu‚Äôil s‚Äôagit de pr√©visualiser des composants complexes ou des pages enti√®res.

En commen√ßant par la story, vous pouvez pr√©visualiser comment le composant sera affich√© dans un vrai navigateur, en fonction de ses donn√©es (props et state) et de la fa√ßon dont l'utilisateur peut interagir avec lui. Cela va faciliter la compr√©hension et le d√©bogage de tout probl√®me que vous rencontrerez lors de l‚Äô√©criture de vos tests.

## Fournir uniquement les contextes requis une seule fois

Les composants complexes n√©cessitent souvent des contextes externes tels que le router, les data stores et l'internationalisation pour fonctionner correctement. M√™me les plus petits composants peuvent n√©cessiter des contextes, comme pour le th√®me de l‚Äôapplication par exemple.

Si vous avez deux m√©caniques distinctes pour la documentation et les tests des composants, vous devrez configurer et cr√©er ces wrappers deux fois. En utilisant les stories comme source de v√©rit√©, vous aller √©viter ce travail suppl√©mentaire et ne d√©finir les contextes requis une seule fois.

# Comment tester les stories avec Jest?

Si vous √™tes toujours en train de lire, j'esp√®re que vous avez √©t√© convaincu de l'importance d'utiliser les sc√©narios Storybook comme fondement de vos tests de composants. Voici les √©tapes √† suivre pour mettre en ≈ìuvre cela techniquement :

Pour simplifier cet article, je vais supposer que vous √™tes d√©j√† familier avec [Testing Library](https://testing-library.com/) et que vous avez une instance Storybook active avec des stories bas√©es sur [CSF 2.0](https://storybook.js.org/docs/react/api/csf).

## Installez le plugin de test

Tout d‚Äôabord, vous devrez installer le plugin Storybook compatible avec votre stack de d√©veloppement. Par exemple, si comme moi vous d√©veloppez avec React, vous pourrez installer `@storybook/testing-react`. De la m√™me facon, si vous travaillez avec Angular ou Vue, vous devrez installer `@storybook/testing-angular` ou `@storybook/testing-vue`.

## Utiliser des stories dans le fichier de test

Un fichier de test simple ressemble g√©n√©ralement √† ceci :

```tsx
import { render, fireEvent } from '@testing-library/react'
import '@testing-library/jest-dom'

import Toggle from './Toggle'

test('<Toggle />', () => {
	const toggleLabel = 'Toggle'
	const { getByText, getByTextLabel} = render(
		<Toggle label={toggleLabel} />
	)
	fireEvent.click(getByText(toggleLabel))
	expect(getByTextLabel(toggleLabel)).toBeChecked()
})
```

M√™me pour un petit composant, pr√®s de la moiti√© des instructions de test sont utilis√©es pour mettre le composant dans le bon √©tat, que nous avons d√©j√† configur√© lors de la cr√©ation de la story.

Le plugin de test Storybook offre des fonctions qui vous permettent de lier les d√©finitions de story aux args et m√©tadonn√©es et de cr√©er des composants pr√™ts √† √™tre rendus.

```tsx
import { render, fireEvent } from '@testing-library/react'
import '@testing-library/jest-dom'
import * as stories from './Toggle.stories'
import { composeStories } from '@storybook/testing-react'
const { Default } = composeStories(stories);

test('<Toggle />', () => {
	render(<Default />)
	// ...
})
```

Chaque composant renvoy√© par `composeStories` est mapp√© sur les stories et inclut d√©j√† tous les d√©corateurs du niveau de la story, du niveau de la m√©ta et du niveau global. Cela peut consid√©rablement simplifier le processus d'√©criture de tests.

Si vous avez besoin d'acc√©der aux arguments de la story, vous pouvez les obtenir √† partir du r√©sultat de `composeStories`.

```tsx
import { render, fireEvent } from '@testing-library/react'
import '@testing-library/jest-dom'
import * as stories from './Toggle.stories'
import { composeStories } from '@storybook/testing-react'
const { Default } = composeStories(stories);

test('<Toggle />', () => {
	const { getByText } = render(<Default />)

	fireEvent.click(getByText(Default.args.label))
	expect(getByLabelText(Default.args.label)).toBeChecked()
})
```

# Conclusion

En conclusion, tester les stories √† l'aide de Jest est une √©tape cruciale pour garantir que vos composants Storybook fonctionnent correctement sur le long terme. Les exemples pr√©sent√©s ci-dessus sont bas√©s sur Testing-Library, mais l'utilisation d'Enzyme pour tester vos stories est similaire.

Si vous pr√©f√©rez utiliser Cypress, la fonctionnalit√© [Component Testing](https://docs.cypress.io/guides/component-testing/overview) peut √™tre utilis√©e √† cette fin. La configuration a √©t√© expliqu√© dans [un article de blog](https://www.cypress.io/blog/2021/05/19/cypress-x-storybook-2-0/) et ne semble √† priori pas √™tre complexe si vous avez d√©j√† configur√© les tests de composants dans votre repository. Cependant, √† titre personnel, je n‚Äôutiliserais pas Cypress que je trouve trop long √† lancer et je ne souhaite pas surcharger mon temps de CI avec cette solution.

Quel que soit l'outil que vous pr√©f√©rez, vous √™tes donc √† pr√©sent en mesure de tester vos stories, de vous assurer une documentation toujours √† jour, ce qui vous fera gagner du temps et r√©duira vos efforts sur le long terme.